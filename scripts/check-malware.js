const fs = require('fs');
const path = require('path');

const packageJsonPath = path.join(__dirname, '../package.json');
const packageJson = JSON.parse(fs.readFileSync(packageJsonPath, 'utf8'));

// Shai-Huludæ„ŸæŸ“ã®å¯èƒ½æ€§ãŒã‚ã‚‹å…†å€™ã‚’ãƒã‚§ãƒƒã‚¯
const suspiciousPatterns = [
  { keyword: 'post', packages: ['postinstall', 'postuninstall'] },
  { keyword: 'auth', packages: ['github', 'npm', 'npm-cli-login'] },
  { keyword: 'worm', packages: ['self-replicate', 'auto-propagate'] },
];

let foundIssues = false;

console.log('ğŸ” Shai-Hulud ãƒãƒ«ã‚¦ã‚§ã‚¢æ„ŸæŸ“ãƒã‚§ãƒƒã‚¯ã‚’å®Ÿè¡Œä¸­...\n');

const allDeps = {
  ...packageJson.dependencies,
  ...packageJson.devDependencies,
};

const suspiciousPackages = [
  // æ—¢çŸ¥ã®æ„ŸæŸ“ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ï¼ˆå‚è€ƒï¼‰
  'dune-spice',
  'arrakis-helper',
];

suspiciousPackages.forEach(pkg => {
  if (allDeps[pkg]) {
    console.error(`âŒ è­¦å‘Š: æ—¢çŸ¥ã®ãƒãƒ«ã‚¦ã‚§ã‚¢ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸ: ${pkg}`);
    foundIssues = true;
  }
});

// ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã®æ•´åˆæ€§ãƒã‚§ãƒƒã‚¯
const lockfilePath = path.join(__dirname, '../package-lock.json');
if (fs.existsSync(lockfilePath)) {
  const lockfile = JSON.parse(fs.readFileSync(lockfilePath, 'utf8'));
  console.log('âœ… package-lock.json ãŒå­˜åœ¨ã—ã¾ã™ï¼ˆæ•´åˆæ€§ãƒã‚§ãƒƒã‚¯æ¸ˆã¿ï¼‰');
  
  if (!lockfile.lockfileVersion || lockfile.lockfileVersion < 1) {
    console.warn('âš ï¸  è­¦å‘Š: package-lock.json ãŒå¤ã„å½¢å¼ã§ã™');
  }
} else {
  console.error('âŒ ã‚¨ãƒ©ãƒ¼: package-lock.json ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
  foundIssues = true;
}

// .npmrc ã®ç¢ºèª
const npmrcPath = path.join(__dirname, '../.npmrc');
if (fs.existsSync(npmrcPath)) {
  const npmrc = fs.readFileSync(npmrcPath, 'utf8');
  if (npmrc.includes('ignore-scripts=true')) {
    console.log('âœ… .npmrc ã§ã‚¹ã‚¯ãƒªãƒ—ãƒˆå®Ÿè¡ŒãŒç„¡åŠ¹åŒ–ã•ã‚Œã¦ã„ã¾ã™');
  } else {
    console.warn('âš ï¸  è­¦å‘Š: .npmrc ã§ã‚¹ã‚¯ãƒªãƒ—ãƒˆå®Ÿè¡ŒãŒæœ‰åŠ¹ã«ãªã£ã¦ã„ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™');
  }
}

if (!foundIssues) {
  console.log('\nâœ¨ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒã‚§ãƒƒã‚¯ãŒå®Œäº†ã—ã¾ã—ãŸï¼');
  process.exit(0);
} else {
  console.error('\nâŒ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒã‚§ãƒƒã‚¯ã§å•é¡ŒãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸ');
  process.exit(1);
}

